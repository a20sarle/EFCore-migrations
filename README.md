Database using EF Core Code First
# Init

## Requirements for updating database using migrations
- ```context.Database.Migrate();``` must be used in the builder / Startup.cs file. ```EnsureCreated()``` does not create the database based on the migration history and therefore it doesn't let the database to be updated using migrations [1].
- The database needs to have one table storing all the migrations, the autogenerated file is called "__EFMigrationsHistory".
- Install EF Core command-line tools using `Install-Package Microsoft.EntityFrameworkCore.Tools` in Package Manager Console [2] to manage migrations from CLI [3].

[1]: https://stackoverflow.com/questions/38238043/how-and-where-to-call-database-ensurecreated-and-database-migrate
[2]: https://docs.microsoft.com/en-us/ef/core/cli/powershell
[3]: https://docs.microsoft.com/en-us/ef/core/managing-schemas/migrations/managing?tabs=vs

## Create a EFMigrationshistory table in the database
1. <a href="https://docs.microsoft.com/en-us/ef/core/cli/powershell">Install Entity Framework Core tools</a> using command `Install-Package Microsoft.EntityFrameworkCore.Tools` in Package Manager Console whic hcan be found in Visual Studio > Tools > NuGet Package Manager > Packet Manager Console.
2. Build the database using code first (minimal requirements is to have one context and one model)
3. Run command `Add-Migration` and check that the autogenerated snapshots of the migration are correct according to the wanted databse structure.
4. Run command `Update-Database` and manually check that the database have been updated and that a table called "__EFMigrationsHistory" has been created.

# Modify database, examples
Afer each modification one will want to first run `add-migration` and check that the autocreated migration snapshots (only) cover the new changes, and then run `update-database` to transcribe the changes from the snapshots to the database.

## Add new field in table [#b7aa95f](https://github.com/a20sarle/EntityFrameworkExample/commit/b7aa95f507e6717d8affd88bf140709d7741ad30) 
Add to model
```
entity.Property(e => e.LastName)
    .HasColumnName("lastname")
    .HasMaxLength(255);
```
Add to context
```
public class SqlWorker
{
    public string? LastName { get; set; }
}
```
Run command `add-migration` and then `update-database`.

## Auto increment int key [#9a56da9](https://github.com/a20sarle/EntityFrameworkExample/commit/9a56da9faa55c38fa264132ff53341228a344845) 
Add to model
```
public class SqlWorker
{
    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]
    public int Id { get; set; }
}
```
Add to context
```
entity.HasKey(e => e.Id);
entity.Property(e => e.Id)
        .HasColumnName("id");
```
## _Don't_ allow null values (empty strings allowed) [#10e5a31](https://github.com/a20sarle/EntityFrameworkExample/commit/10e5a31f323455afc4b1f2d270c5e349a7feca6b)
Add to model
```
public class SqlWorker
{
    public string FirstName { get; set; }
}
```
Add to context
```
entity.Property(e => e.FirstName)
    .HasColumnName("firstname")
    .IsRequired();
```

## Allow null values
Add to model
```
public class SqlWorker
{
    public string? FirstName { get; set; }
}
```
Add to context
```
entity.Property(e => e.FirstName)
    .HasColumnName("firstname")
    .IsRequired(false);
```


## Commands

Package manager Console                             | CLI                                        | Description
------------------------------                      | -----------------------------------------  | ----------------------
`add-migration <migrationName>`                     | `dotnet ef migrations add <migrationName>` | Creates migration
`update-databse`                                    | `dotnet ef database update`                | Updates the database based on the migration history
`update-database -migration:"<migrationname>"`      | ?                                          | Rollback to a specific version of the database 
`remove-migration`                                  | `dotnet ef migrations remove`              | Removes the last migration
`get-migration`                                     | `dotnet ef migrations list`                | See what migrations are applied in the database
`update-database -migration 0`                      | ?                                          | Reset and empty the database (all data and tables will be lost). To                                                                                                    get a completely new start all tables in the database needs to be                                                                                                      dropped and the migrations folder in the project needs to be                                                                                                            deleted.
`Script-Migration`                                  | `dotnet ef migrations script`              | --


## Update database Step by step
1. 

## Other resources
Add _EFMigrationsHistory file: https://www.entityframeworktutorial.net/efcore/entity-framework-core-migration.aspx

